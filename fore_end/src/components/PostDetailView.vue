<template>
    <div class="wrapper-wrapper">
        <h2 class="post-detail">栏目详情</h2>
        <div class="post-title-wrapper">
            <div class="post-title">
                <div class="post-info-t">
                    <h3>{{ post_info.post_name }}</h3>
                    <span>{{ post_info.c_time }}</span>
                </div>
                <p class="post-id">@ {{ postId }}</p>
                <p class="post-desp">{{ post_info.description }}</p>
            </div>
            <div class="point-wrapper" ref="starWrapper" @click="showtools = !showtools">
                <svg t="1680700154918" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                    p-id="3928" width="200" height="200">
                    <path
                        d="M341.333333 512a85.333333 85.333333 0 1 1-170.666666 0 85.333333 85.333333 0 0 1 170.666666 0z m256 0a85.333333 85.333333 0 1 1-170.666666 0 85.333333 85.333333 0 0 1 170.666666 0z m170.666667 85.333333a85.333333 85.333333 0 1 0 0-170.666666 85.333333 85.333333 0 0 0 0 170.666666z"
                        fill="#ffffff" p-id="3929"></path>
                </svg>
                <div class="star-wrapper" v-show="showtools">
                    <div class="s-tools">
                        <svg t="1680750337549" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="2788" width="200" height="200">
                            <path d="M872.802928 755.99406 872.864326 755.99406 872.864326 755.624646Z" fill="#ffffff"
                                p-id="2789"></path>
                            <path
                                d="M809.889039 214.109426c-164.252925-164.278507-431.528224-164.278507-595.778078 0-164.280554 164.250878-164.280554 431.527201 0 595.781148 164.250878 164.276461 431.526177 164.276461 595.778078 0C974.16857 645.636626 974.16857 378.360304 809.889039 214.109426M767.13326 767.130701c-140.681066 140.712789-369.617176 140.683113-510.281869 0-140.694369-140.67902-140.694369-369.585453 0-510.279822 140.664693-140.664693 369.601826-140.694369 510.281869 0C907.812279 397.516596 907.812279 626.481358 767.13326 767.130701"
                                fill="#ffffff" p-id="2790"></path>
                            <path
                                d="M602.493525 338.736864c-32.254611 0-63.968917 16.619516-90.523713 47.111994-26.464745-30.491455-58.211796-47.111994-90.465384-47.111994-75.30715 0-136.547933 66.088184-136.547933 147.31823 0 38.565341 24.124444 89.705068 55.092759 117.8992 28.496008 35.20685 144.231939 140.649344 172.305321 140.649344 26.764574 0 139.576919-100.787474 170.33955-139.365094 32.132838-29.330002 56.360635-80.55978 56.360635-119.18345C739.056807 404.825049 677.801698 338.736864 602.493525 338.736864M644.593366 563.495838l-3.310396 3.013637-2.805906 3.491521c-23.599488 29.627784-93.117794 91.060949-126.208447 112.990401-33.985022-22.557762-106.159832-87.301322-128.297015-114.603131l-2.685155-3.311419-3.163039-2.892887c-21.005406-19.094894-36.640502-55.959499-36.640502-76.128865 0-50.065256 35.894512-90.792842 80.021521-90.792842 15.33629 0 32.31294 9.801227 47.829332 27.643594l42.636053 49.097208 42.663682-49.067532c15.516392-17.841344 32.522718-27.67327 47.860031-27.67327 44.128033 0 80.051197 40.726563 80.051197 90.792842C682.544723 506.314511 666.940326 543.117718 644.593366 563.495838"
                                fill="#ffffff" p-id="2791"></path>
                        </svg>
                        <span>关注栏目</span>
                    </div>
                    <div class="s-tools">
                        <svg t="1680750337549" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="2788" width="200" height="200">
                            <path d="M872.802928 755.99406 872.864326 755.99406 872.864326 755.624646Z" fill="#ffffff"
                                p-id="2789"></path>
                            <path
                                d="M809.889039 214.109426c-164.252925-164.278507-431.528224-164.278507-595.778078 0-164.280554 164.250878-164.280554 431.527201 0 595.781148 164.250878 164.276461 431.526177 164.276461 595.778078 0C974.16857 645.636626 974.16857 378.360304 809.889039 214.109426M767.13326 767.130701c-140.681066 140.712789-369.617176 140.683113-510.281869 0-140.694369-140.67902-140.694369-369.585453 0-510.279822 140.664693-140.664693 369.601826-140.694369 510.281869 0C907.812279 397.516596 907.812279 626.481358 767.13326 767.130701"
                                fill="#ffffff" p-id="2790"></path>
                            <path
                                d="M602.493525 338.736864c-32.254611 0-63.968917 16.619516-90.523713 47.111994-26.464745-30.491455-58.211796-47.111994-90.465384-47.111994-75.30715 0-136.547933 66.088184-136.547933 147.31823 0 38.565341 24.124444 89.705068 55.092759 117.8992 28.496008 35.20685 144.231939 140.649344 172.305321 140.649344 26.764574 0 139.576919-100.787474 170.33955-139.365094 32.132838-29.330002 56.360635-80.55978 56.360635-119.18345C739.056807 404.825049 677.801698 338.736864 602.493525 338.736864M644.593366 563.495838l-3.310396 3.013637-2.805906 3.491521c-23.599488 29.627784-93.117794 91.060949-126.208447 112.990401-33.985022-22.557762-106.159832-87.301322-128.297015-114.603131l-2.685155-3.311419-3.163039-2.892887c-21.005406-19.094894-36.640502-55.959499-36.640502-76.128865 0-50.065256 35.894512-90.792842 80.021521-90.792842 15.33629 0 32.31294 9.801227 47.829332 27.643594l42.636053 49.097208 42.663682-49.067532c15.516392-17.841344 32.522718-27.67327 47.860031-27.67327 44.128033 0 80.051197 40.726563 80.051197 90.792842C682.544723 506.314511 666.940326 543.117718 644.593366 563.495838"
                                fill="#ffffff" p-id="2791"></path>
                        </svg>
                        <span @click="invite_cooperation">发起合作邀请</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="post-tip">
            <div class="review">
                <span class="r-num">1.2w</span>
                <span>评论</span>
            </div>
            <div class="review">
                <span class="r-num">1.2w</span>
                <span>b</span>
            </div>
        </div>
        <div class="s-icon">
            <svg t="1680754957038" class="review-icon" viewBox="0 0 1058 1024" version="1.1"
                xmlns="http://www.w3.org/2000/svg" p-id="2764" width="200" height="200" @click="toggleCommentBox">
                <path
                    d="M330.744242 885.372121l194.779798-129.861818 16.665859-11.106263h383.844848c36.486465 0 66.19798-29.659798 66.19798-66.146262v-529.19596c0-36.434747-29.711515-66.107475-66.19798-66.107475H132.305455c-36.486465 0-66.146263 29.659798-66.146263 66.107475v529.19596c0 36.486465 29.659798 66.146263 66.146263 66.146262h198.438787v140.968081m-66.146262 123.578182V810.550303H132.305455c-73.024646 0-132.305455-59.216162-132.305455-132.292525v-529.19596C0 76.024242 59.267879 16.808081 132.305455 16.808081h793.742222c73.076364 0 132.357172 59.216162 132.357171 132.240808v529.195959c0 73.076364-59.267879 132.292525-132.357171 132.292526h-363.830303L264.59798 1008.950303z m0 0"
                    p-id="2765" fill="#8b98a5"></path>
            </svg>
        </div>
        <div class="all-comment">
            <!-- 评论 -->
            <ul>
                <li class="per_comment" v-for="comment in all_comments">
                    <div class="icon"><svg t="1680790822459" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="2589" width="200" height="200">
                            <path
                                d="M526.336 68.608q91.136 0 171.008 32.768t139.264 89.6 93.696 133.632 34.304 163.84q0 88.064-35.328 164.864t-96.768 134.144q-19.456 21.504-51.2 21.504-22.528 0-41.984-13.312-43.008-27.648-61.952-57.856t-27.648-62.464-12.288-65.536-14.848-66.56-36.352-67.072-76.288-67.584q-25.6-16.384-48.128-24.576t-45.056-14.848-44.032-14.336-45.056-23.552-48.64-41.984-52.736-69.12q25.6-36.864 60.928-65.024t75.264-47.616 81.92-29.184 81.92-9.728zM570.368 545.792q14.336 31.744 19.968 61.44t8.704 57.344 8.704 52.736 20.48 48.128 42.496 44.032 76.8 39.424q3.072 3.072 5.12 11.776t5.12 19.968 9.728 26.112 19.968 30.208q-92.16 22.528-171.008 25.6t-158.72-20.48q9.216-22.528 13.312-40.96t5.12-34.304 0.512-30.208-1.536-29.696q-2.048-29.696-20.992-36.864t-44.032-3.584-50.176 12.288-40.448 10.752q-17.408 3.072-36.352 4.608t-35.328-1.024-26.112-9.728-6.656-22.528q2.048-12.288 4.608-28.672t2.56-33.792-5.632-33.28-19.968-27.136q-6.144-4.096-19.968-10.752t-26.112-14.848-18.432-16.384 3.072-16.384q20.48-15.36 41.984-34.816t32.768-41.984q5.12-10.24 6.144-21.504t-0.512-20.992-3.584-17.408-2.048-12.8-4.096-13.312-8.192-22.528-6.144-35.84 2.048-54.272q-26.624 7.168-37.888 30.72t-7.168 58.368q-16.384-24.576-17.408-45.568t6.656-37.888 22.528-30.208 31.232-22.528q26.624 57.344 57.856 86.016t65.536 43.52 69.12 21.504 68.096 19.968 63.488 39.424 54.784 78.336z"
                                p-id="2590" fill="#d2d0dd"></path>
                        </svg></div>
                    <div class="content-wrapper">
                        <div class="user">
                            <span class="addr">{{ comment.commentator }}</span>
                            <span class="time">{{ comment.comment_time }}</span>
                        </div>
                        <div class="content">{{ comment.comment_text }}</div>
                        <div class="tool">
                            <svg t="1680791389641" class="" viewBox="0 0 1024 1024" version="1.1"
                                xmlns="http://www.w3.org/2000/svg" p-id="3095" width="200" height="200">
                                <path
                                    d="M466.318679 81.831587l-183.304473 71.176943a119.46769 119.46769 0 0 0-7.218387 3.536539c-7.567334 3.87116-13.737858 8.222249-18.627206 13.34491-10.769253 11.031219-14.610737 24.753727-14.086805 44.239485V430.381261l-191.163448 71.672223c-11.176528 3.405556-21.305192 9.298765-29.163146 17.07076-10.88591 10.258624-17.347052 23.821497-16.764791 41.022216v134.145965l-0.058329 89.993461c0 34.431115 6.636127 41.940121 37.196083 58.355966l193.957069 102.275156c28.406923 10.62292 40.689643 15.687253 71.656873 0l9.663061-4.977351 175.271536-90.45804v-0.028653l0.058328-0.028653 0.058329-0.029675 0.058328-0.058329 0.058328-0.028652 0.058329-0.058329 0.116656-0.058328 0.058329-0.059352 0.116656-0.058328 0.115634-0.086981 0.116656-0.059351 0.115634-0.086981 0.174985-0.086981 0.116656-0.088004 0.173962-0.086981 0.174985-0.116657 0.174985-0.086981 0.173962-0.115633 0.173961-0.088004 0.233314-0.115633 0.174985-0.116657 0.233313-0.115634 0.233313-0.116656 0.233314-0.115634 0.233313-0.116656 0.233314-0.145309 0.290618-0.116657 0.233313-0.115633 0.291642-0.146333 0.291642-0.115633 0.290618-0.146333 0.290618-0.116657 0.34997-0.115633 0.290619-0.146332 0.348946-0.14531 0.291642-0.116656 0.348947-0.115634 0.34997-0.146332 0.348947-0.116657 0.407275-0.115633 0.348946-0.115634 0.348947-0.116656 0.407275-0.116657 0.407275-0.145309 0.407275-0.086981 0.407275-0.116657 0.407275-0.116656 0.407275-0.115634 0.465604-0.08698 0.407275-0.116657 0.465603-0.086981 0.465604-0.088004 0.465603-0.086981 0.465603-0.086981 0.465604-0.059352 0.465603-0.08698 0.465604-0.058329 0.523931-0.059351 0.465604-0.058329h0.058328l0.465603-0.058328 0.523932-0.028653 0.523932-0.058328 0.523932 0.058328 0.524955 0.028653 0.465603 0.058328 0.523932 0.058329 0.465603 0.059351 0.523932 0.058329 0.465603 0.08698 0.465604 0.059352 0.465603 0.086981 0.465603 0.086981 0.465604 0.088004 0.407275 0.086981h0.058328l0.407275 0.116657 0.407275 0.08698 0.465604 0.115634 0.406251 0.116656 0.407276 0.116657 0.34997 0.086981 0.407275 0.145309 0.406251 0.116657 0.407275 0.116656 0.348947 0.115634 0.34997 0.115633 0.407275 0.116657 0.290619 0.146332 0.348946 0.115634 0.34997 0.116656 0.34997 0.14531 0.290619 0.146332 0.290618 0.115633 0.34997 0.116657 0.290618 0.146333 0.290619 0.115633 0.233313 0.146333 0.290619 0.115633 0.233313 0.116657 0.290618 0.145309 0.234337 0.116656 0.23229 0.115634 0.234337 0.116656 0.23229 0.115634 0.174985 0.116657 0.233313 0.115633 0.174985 0.088004 0.174985 0.115633 0.173962 0.086981 0.174985 0.116657 0.174985 0.086981 0.115633 0.088004 0.174985 0.086981 0.116657 0.086981 0.115633 0.059351 0.116657 0.086981 0.115633 0.058328 0.059352 0.059352 0.058328 0.058328 0.115634 0.058329 0.058328 0.028652 0.059352 0.058329v0.029675h0.058328l0.058328 0.028653v0.028653l175.271536 90.45804 9.663061 4.977351c30.908902 15.687253 43.24995 10.62292 71.65585 0l190.464532-100.412743c25.902898-13.767534 39.234505-20.228676 40.514658-51.66151 2.095727-30.444322 0.116657-67.379462 0.116657-98.551353V560.14646c0.581237-17.201743-5.879906-30.763593-16.822097-41.02324-7.858976-7.771995-17.929312-13.665204-29.164169-17.07076l-191.104097-71.672223-0.059352-216.251796c0.58226-19.485758-3.260247-33.20929-14.028476-44.239485-4.889347-5.122661-11.1182-9.47375-18.627206-13.34491-4.482072-2.372019-8.499564-4.060471-13.155598-5.864556l-177.366239-68.847903c-13.32956-5.195315-30.794292-12.776976-45.288372-12.704322-14.495103-0.073678-31.958812 7.509006-45.288372 12.704322z m-193.609145 400.793444l201.816045 82.790422-201.816045 82.775073-201.756694-82.775073 201.756694-82.790422z m478.314873 0l201.757717 82.790422-201.757717 82.775073-201.815021-82.775073 201.815021-82.790422zM546.35846 356.540656l165.666803-70.4637v144.347284l-165.666803 67.626078V356.540656zM308.509829 710.649942l165.666803-76.110293v152.801823l-165.666803 84.550505v-161.242035z m475.753544 0l165.667826-76.110293v152.801823l-165.667826 84.550505v-161.242035zM509.860271 128.414438l201.756693 82.789399-201.756693 82.760747-201.757717-82.760747 201.757717-82.789399z"
                                    fill="#71767b" p-id="3096"></path>
                            </svg>
                            <span>100b</span>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>
    <div class="comment-box-overlay" v-show="showCommentBox" @click="toggleCommentBox">
        <div class="comment-box" @click.stop>
            <div class="comment">
                <svg t="1680756370007" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                    p-id="3809" width="200" height="200">
                    <path
                        d="M222.208 631.296l-36.352 61.952s-18.432 122.368 22.528 145.408c40.448 23.04 139.776-53.248 139.776-53.248l35.328-59.392-162.304-91.648 1.024-3.072z m360.448-243.712l-162.304-92.16 23.552-39.936 162.304 91.648L629.76 307.2c19.456-32.768 7.68-74.752-25.6-94.208l-40.448-23.04c-33.792-18.944-76.8-7.68-96.256 25.088l-222.72 377.344 162.304 91.648 191.488-324.608-15.872 28.16zM796.16 746.496H465.92c-25.088 0-46.08 20.48-46.08 46.08 0 25.088 20.48 46.08 46.08 46.08h330.24c25.088 0 46.08-20.48 46.08-46.08s-20.48-46.08-46.08-46.08z"
                        fill="#1d9bf0" p-id="3810"></path>
                </svg>
                <div class="review">
                    <div class="false draftjs-styles_2">
                        <div style="max-height: 720px; min-height: 96px;">
                            <div class="DraftEditor-root">
                                <div class="edit-input">
                                    发布你的回复
                                </div>
                                <div>
                                    <div class="public-DraftEditor-content" contenteditable="true"
                                        data-testid="tweetTextarea_0" role="textbox" spellcheck="true" tabindex="0"
                                        no-focustrapview-refocus="true"
                                        style="outline: none; user-select: text; white-space: pre-wrap; overflow-wrap: break-word;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <button class="submit" @click="clickSubmit">提交</button>
        </div>
    </div>
</template>
  
<script>
import Web3 from 'web3';
import { PostManagementABI, PostManagementAddress } from "../contracts/PostManagement"
import { CommentManagementABI, CommentManagementAddress } from "../contracts/CommentManagement"
import { mapMutations, mapState } from "vuex"
import { RelationShipManagementABI, RelationShipManagementAddress } from '../contracts/RelationShipManagement';
export default {
    name: "PostDetailView",
    data() {
        return {
            post_info: [],
            showtools: false,
            showCommentBox: false,
            all_comments: []
        }
    },
    computed: {
        postId() {
            return this.$route.params.id;
        },
    },
    async mounted() {
        this.initContract();
        document.addEventListener('click', this.handleClickOutside);
        this.post_info = await this.get_post_info();
        this.all_comments = await this.get_all_comments();
    },
    beforeDestroy() {
        document.removeEventListener('click', this.handleClickOutside);
    },
    methods: {
        async invite_cooperation() {
            //发起合作邀请
            const web3 = new Web3(window.ethereum);

            let contractInstance = new web3.eth.Contract(RelationShipManagementABI, RelationShipManagementAddress);
            await contractInstance.methods.invite_cooperation(PostManagementAddress, this.postId).send(
                { from: this.user_addr }, (err, res) => {
                    if (err) {
                        console.log(err);
                    } else {
                        console.log(res);
                    }
                }
            );

        },
        async get_all_comments() {
            const web3 = new Web3(window.ethereum);
            let contractInstance_comment = new web3.eth.Contract(CommentManagementABI, CommentManagementAddress);
            let size = await contractInstance_comment.methods.get_comment_length(this.postId).call();
            let c_data = [];
            for (let i = 0; i < size; i++) {
                let _comment = await contractInstance_comment.methods.TotalComments(this.postId, i).call()
                let _post = JSON.parse(JSON.stringify(_comment));
                _post["comment_time"] = new Date(_post["comment_time"] * 1000).toLocaleString();
                c_data.push(_post);
            }
            c_data.sort(function (a, b) {
                return new Date(b["comment_time"]) - new Date(a["comment_time"]);
            })
            return c_data;
        },
        ...mapMutations(["set_post_li"]),
        ...mapMutations(["set_web"]),
        ...mapState(["user_addr"]),
        async get_post_info() {
            if (!this.contractInstance) {
                this.initContract();
            }
            let post = await this.contractInstance.methods.PostMap(this.$route.params.id).call();
            post = JSON.parse(JSON.stringify(post));
            console.log(post);
            post["c_time"] = new Date(post["c_time"] * 1000).toLocaleString();
            return post;
        },
        handleClickOutside(event) {
            if (this.$refs.starWrapper && !this.$refs.starWrapper.contains(event.target)) {
                this.showtools = false;
            }
        },
        toggleCommentBox() {
            this.showCommentBox = !this.showCommentBox;
        },
        clickSubmit() {
            // 发布评论
            const web3 = new Web3(window.ethereum);
            let contractInstance_comment = new web3.eth.Contract(CommentManagementABI, CommentManagementAddress);
            console.log("评论", this.postId, $(".public-DraftEditor-content").html(), localStorage.getItem('userAddress'));
            contractInstance_comment.methods.post_comment(this.postId, $(".public-DraftEditor-content").html()).send({ from: localStorage.getItem('userAddress') })
                .then(recepit => {
                    console.log(recepit);
                })
            // 关闭评论框
            this.showCommentBox = false;
        },
        initContract() {
            if (window.ethereum) {
                const web3 = new Web3(window.ethereum);
                this.set_web(web3);
                this.userAddress = (web3.eth.getAccounts())[0];
                // 创建合约实例
                this.contractInstance = new web3.eth.Contract(PostManagementABI, PostManagementAddress);

            } else {
                console.error('请安装 MetaMask 插件');
            }

        },
    },
};
</script>

<style scoped>
@import "../css/postdetail.css";
</style>
  